import os
import asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, ContextTypes, filters
import subprocess

TOKEN = "YOUR_BOT_TOKEN_HERE"

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø©
QUALITY_PRESETS = {
    "high": {"crf": 23, "size": "70%", "name": "Ø¹Ø§Ù„ÙŠØ© ğŸ”¥"},
    "medium": {"crf": 28, "size": "50%", "name": "Ù…ØªÙˆØ³Ø·Ø© âš¡"},
    "low": {"crf": 32, "size": "30%", "name": "Ù…Ù†Ø®ÙØ¶Ø© ğŸ“‰"}
}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "Ø£Ù‡Ù„Ø§Ù‹! ğŸ¬\n\n"
        "Ø£Ø±Ø³Ù„ ÙÙŠØ¯ÙŠÙˆ ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨Ø¶ØºØ·Ù‡ Ù„Ùƒ\n"
        "Ø§Ø³ØªØ®Ø¯Ù… /help Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯"
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ğŸ“¹ ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:\n\n"
        "1. Ø£Ø±Ø³Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ\n"
        "2. Ø§Ø®ØªØ± Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©\n"
        "3. Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø¶ØºØ·\n\n"
        "âœ¨ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ© = Ø­Ø¬Ù… Ø£Ù‚Ù„ Ù…Ø¹ Ø¬ÙˆØ¯Ø© Ù…Ù…ØªØ§Ø²Ø©\n"
        "âš¡ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© = ØªÙˆØ§Ø²Ù† Ø¨ÙŠÙ† Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„Ø¬ÙˆØ¯Ø©\n"
        "ğŸ“‰ Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ù†Ø®ÙØ¶Ø© = Ø£ØµØºØ± Ø­Ø¬Ù… Ù…Ù…ÙƒÙ†"
    )

async def handle_video(update: Update, context: ContextTypes.DEFAULT_TYPE):
    video = update.message.video or update.message.document
    
    if not video:
        return
    
    # Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    context.user_data['video_file_id'] = video.file_id
    context.user_data['video_size'] = video.file_size
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
    keyboard = [
        [InlineKeyboardButton(QUALITY_PRESETS["high"]["name"], callback_data="high")],
        [InlineKeyboardButton(QUALITY_PRESETS["medium"]["name"], callback_data="medium")],
        [InlineKeyboardButton(QUALITY_PRESETS["low"]["name"], callback_data="low")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    size_mb = video.file_size / (1024 * 1024)
    await update.message.reply_text(
        f"ğŸ“Š Ø­Ø¬Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: {size_mb:.1f} MB\n\n"
        f"Ø§Ø®ØªØ± Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:",
        reply_markup=reply_markup
    )

async def compress_video(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    quality = query.data
    preset = QUALITY_PRESETS[quality]
    
    msg = await query.message.reply_text("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...")
    
    try:
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        video_file = await context.bot.get_file(context.user_data['video_file_id'])
        input_path = f"input_{query.from_user.id}.mp4"
        output_path = f"output_{query.from_user.id}.mp4"
        
        await video_file.download_to_drive(input_path)
        
        await msg.edit_text("ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¶ØºØ·...")
        
        # Ø¶ØºØ· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… FFmpeg
        cmd = [
            "ffmpeg", "-i", input_path,
            "-c:v", "libx264",
            "-crf", str(preset["crf"]),
            "-preset", "fast",
            "-c:a", "aac",
            "-b:a", "128k",
            "-movflags", "+faststart",
            "-y", output_path
        ]
        
        process = await asyncio.create_subprocess_exec(
            *cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )
        await process.communicate()
        
        if os.path.exists(output_path):
            # Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶ØºØ·
            original_size = os.path.getsize(input_path) / (1024 * 1024)
            compressed_size = os.path.getsize(output_path) / (1024 * 1024)
            reduction = ((original_size - compressed_size) / original_size) * 100
            
            await msg.edit_text("ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...")
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¶ØºÙˆØ·
            with open(output_path, 'rb') as video:
                await query.message.reply_video(
                    video=video,
                    caption=f"âœ… ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¨Ù†Ø¬Ø§Ø­!\n\n"
                            f"ğŸ“Š Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ: {original_size:.1f} MB\n"
                            f"ğŸ“‰ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: {compressed_size:.1f} MB\n"
                            f"ğŸ’¾ ØªÙ… Ø§Ù„ØªÙˆÙÙŠØ±: {reduction:.0f}%"
                )
            
            await msg.delete()
        else:
            await msg.edit_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¶ØºØ·")
        
    except Exception as e:
        await msg.edit_text(f"âŒ Ø®Ø·Ø£: {str(e)}")
    
    finally:
        # Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        for path in [input_path, output_path]:
            if os.path.exists(path):
                os.remove(path)

def main():
    app = Application.builder().token(TOKEN).build()
    
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(MessageHandler(filters.VIDEO | filters.Document.VIDEO, handle_video))
    app.add_handler(CallbackQueryHandler(compress_video))
    
    print("ğŸ¤– Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†...")
    app.run_polling()

if __name__ == "__main__":
    main()